<?xml version="1.0" encoding="UTF-8"?>
<project name="build" default="build" basedir=".">

    <!-- this is the absolute path to the root -->
    <pathconvert property="root.dir">
        <path location="${basedir}/../../.." />
    </pathconvert>
    <property name="target.dir" value="${basedir}/deploy/" />
    <property name="swagger.file" value="TODO.json" />
    <property name="appfile.file" value="TODO.app" />
    <property file="${basedir}/../../server.properties" />

    <target name="build">
        <antcall target="build-application" />
    </target>

    <import file="${root.dir}/xyna-factory/installation/build/buildApplication.xml" />

    <target name="clean" description="delete output folder">
        <delete dir="${target.dir}"/>
    </target>

    <target name="build-oas-datamodel" description="build an OAS Datamodel Application" depends="clean">
        <mkdir dir="${target.dir}" />
      
        <java classname="org.openapitools.codegen.OpenAPIGenerator">
            <arg value="generate" />
            <arg value="-g" /> 
            <arg value="xmom-data-model" />
            <arg value="-i" />
            <arg value="../../specification/${swagger.file}" />
            <arg value="-o" />
            <arg value="${target.dir}" /> 
            <classpath>
                <pathelement location="../../../xyna-factory/installation/build/lib/factory/openapi-generator-cli-6.6.0.jar" />
                <pathelement location="../../../xyna-factory/installation/build/lib/factory/xmom-data-model-openapi-generator-1.0.0.jar" />
            </classpath>
        </java>

        <zip destfile="${target.dir}/${appfile.file}"
             basedir="${target.dir}"
             includes="XMOM/, application.xml" />
    </target>


    <target name="build-oas-provider" description="build an OAS Provider Application" depends="clean">
        <mkdir dir="${target.dir}" />
        <mkdir dir="./common/lib" />
        <mkdir dir="./filterImpl/OASFilter/xmldefinition" />

      
        <java classname="org.openapitools.codegen.OpenAPIGenerator">
            <arg value="generate" />
            <arg value="-g" /> 
            <arg value="xmom-server" />
            <arg value="-i" />
            <arg value="../../specification/${swagger.file}" />
            <arg value="-o" />
            <arg value="${target.dir}" /> 
            <classpath>
                <pathelement location="../../../xyna-factory/installation/build/lib/factory/openapi-generator-cli-6.6.0.jar" />
                <pathelement location="../../../xyna-factory/installation/build/lib/factory/xmom-server-openapi-generator-1.0.0.jar" />
            </classpath>
        </java>

        <exec executable="../../../xyna-factory/modules/xfmg/oas/buildApplication.py">
            <arg value="--app-dir"/>
            <arg value="./deploy"/>
            <arg value="--filter-dir"/>
            <arg value="./filterImpl/OASFilter"/>
        </exec>

        <move file="${target.dir}/deploy.zip" tofile="${target.dir}/${appfile.file}"></move>
  
    </target>

    <target name="build-oas-client" description="build an OAS Provider Application" depends="clean">
  
        <mkdir dir="${target.dir}" />
      
        <java classname="org.openapitools.codegen.OpenAPIGenerator">
            <arg value="generate" />
            <arg value="-g" /> 
            <arg value="xmom-client" />
            <arg value="-i" />
            <arg value="../../specification/${swagger.file}" />
            <arg value="-o" />
            <arg value="${target.dir}" /> 
            <classpath>
                <pathelement location="../../../xyna-factory/installation/build/lib/factory/openapi-generator-cli-6.6.0.jar" />
                <pathelement location="../../../xyna-factory/installation/build/lib/factory/xmom-client-openapi-generator-1.0.0.jar" />
            </classpath>
        </java>

        <exec executable="../../../xyna-factory/modules/xfmg/oas/buildApplication.py">
            <arg value="--app-dir"/>
            <arg value="./deploy"/>
        </exec>

        <move file="${target.dir}/deploy.zip" tofile="${target.dir}/${appfile.file}"></move>
  
    </target>

    <target name="copy_to_server" description="kopiert den Liefergegenstand auf den Xyna Server">
        <echo message="user: ${server.user}"/>
        <echo message="host: ${server.host}"/>
        <echo message="userHome: ${user.home}"/>
      
        <scp file="${target.dir}/${appfile.file}" 
            todir="${server.user}@${server.host}:~/Lieferung/" 
            trust="true"
            failonerror="true"
            verbose="true" 
            keyfile="/home/gipadmin/.ssh/id_ecdsa"/>
    </target>


</project>
