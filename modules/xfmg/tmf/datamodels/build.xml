<?xml version="1.0" encoding="UTF-8"?>
<!--
 * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 * Copyright 2025 Xyna GmbH, Germany
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
-->
<project name="build" default="build" basedir=".">

	<!-- this is the absolute path to the root -->
	<pathconvert property="root.dir">
		<path location="../../../.." />
	</pathconvert>

	<pathconvert property="project.root.dir">
		<path location="../.." />
	</pathconvert>

	<property name="target.dir" value="${basedir}/deploy/" />
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${common.xyna.lib.dir}/ant-contrib.jar" />
		</classpath>
	</taskdef>

	<target name="build">
		<!-- create apps from open api schemas and also unzip them for tmf tools to be able to find the xmom files -->
		<ant antfile="build.xml" dir="${root.dir}/modules/xfmg/oas" target="prepare-mdm-jar-if-missing" />
		<ant antfile="build.xml" dir="${root.dir}/modules/xfmg/oas" target="replace-appversion" />
		<ant antfile="build.xml" dir="${root.dir}/modules/xfmg/oas/mdmimpl/ApplicationGenerationImpl/" target="build">
			<property name="target.dir" value="${root.dir}/modules/xfmg/oas/mdmimpl/ApplicationGenerationImpl/deploy" />
		</ant>
		<java classname="xfmg.oas.offline.OASApplicationGeneration" fork="true" failonerror="true">
			<arg value="tmf633-service-catalog-openapi-1.1.15.yaml" />
			<arg value="client" />
			<arg value="." />
			<classpath>
				<fileset dir="${root.dir}/modules/xfmg/oas/mdmimpl/ApplicationGenerationImpl/lib/xyna">
					<include name="*.jar" />
				</fileset>
				<fileset dir="${root.dir}/modules/xfmg/oas/mdmimpl/ApplicationGenerationImpl/deploy">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</java>
		<java classname="xfmg.oas.offline.OASApplicationGeneration" fork="true" failonerror="true">
			<arg value="tmf640-service-activation-openapi-1.1.8.yaml" />
			<arg value="datamodel" />
			<arg value="." />
			<classpath>
				<fileset dir="${root.dir}/modules/xfmg/oas/mdmimpl/ApplicationGenerationImpl/lib/xyna">
					<include name="*.jar" />
				</fileset>
				<fileset dir="${root.dir}/modules/xfmg/oas/mdmimpl/ApplicationGenerationImpl/deploy">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</java>
		<antcall target="unzipApps" />
		<move todir="${target.dir}">
			<fileset dir="${basedir}" includes="*.zip" />
			<regexpmapper from="^(.*)_((?:\d+\.){3})zip" to="\1.\2app" />
		</move>
	</target>

	<target name="unzipApps">
		<foreach target="unzipApp" param="zipfile">
			<fileset dir="${basedir}" includes="*.zip" >
			</fileset>
		</foreach>
	</target>

	<target name="unzipApp">
		<basename property="filename" file="${zipfile}" suffix=".zip"/>
		<unzip src="${zipfile}" dest="${basedir}/${filename}"/>
	</target>

</project>
