<?xml version="1.0" encoding="UTF-8"?>
<!--
 * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 * Copyright 2023 Xyna GmbH, Germany
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
-->
<project name="ant-xyna" basedir="." xmlns:resolver="antlib:org.apache.maven.resolver.ant">

  <dirname property="ant.file.ant-xyna.dir" file="${ant.file.ant-xyna}" />

  <tstamp>
    <format property="timestamp" pattern="yyyyMMdd_HHmm" locale="de,DE" />
  </tstamp>

  <tstamp>
    <format property="timestamp.long"
            pattern="yyyyMMdd_HHmmssSS"
            locale="de,DE" />
  </tstamp>

  <property environment="env" />

  <!-- needed for sqlplus -->
  <condition property="nls_lang"
             value="${env.NLS_LANG}"
             else="GERMAN_GERMANY.WE8ISO8859P15">
    <isset property="${env.NLS_LANG}" />
  </condition>

  <property name="xynaTarget.default" value="notset" />

  <property name="vendor.name" value="Xyna GmbH" />

  <condition property="isInstall" value="true" else="false">
    <not>
      <available file="${ant.file.ant-xyna.dir}/build.xml" />
    </not>
  </condition>

  <condition property="isOracleAS" value="true" else="false">
    <isset property="as.port.opmn" />
  </condition>

  <property name="install.lib.dir" value="${ant.file.ant-xyna.dir}/lib" />

  <!-- remove filename/.. from path because sqlplus dont accepts it -->
  <pathconvert property="sql.dir">
    <path>
      <dirset dir="${ant.file.ant-xyna.dir}">
        <include name="sql" />
      </dirset>
    </path>
  </pathconvert>

  <taskdef resource="net/sf/antcontrib/antlib.xml"/>

  <if>
    <and>
      <not>
        <equals arg1="${isInstall}" arg2="true" />
      </not>
      <isset property="cobertura.available" />
    </and>
    <then>
      <taskdef resource="tasks.properties" classpathref="classpath.cobertura" />
    </then>
  </if>

  <!-- = = = = = = = = = = = = = = = = =
            macrodef: checkProperty          
           = = = = = = = = = = = = = = = = = -->
  <macrodef name="checkProperty"
            description="Check if the specific property is set, fail if not.">
    <attribute name="name" />
    <sequential>
      <fail message="Property @{name} is not set!">
        <condition>
          <not>
            <isset property="@{name}" />
          </not>
        </condition>
      </fail>
    </sequential>
  </macrodef>

  <if>
    <equals arg1="${isInstall}" arg2="true" />
    <then>
      <property file="${ant.file.ant-xyna.dir}/patch.properties" />
    </then>
    <else>
      <property file="${ant.file.ant-xyna.dir}/../delivery/patch.properties" />
    </else>
  </if>

  <!-- macro for executing a command plattform independent -->
  <macrodef name="execute">
    <attribute name="executable"/>
    <element name="args" implicit="yes"/>
    <sequential>
      <exec osfamily="windows" executable="cmd" outputproperty="exec.output">
        <arg value="/c"/>
        <arg value="@{executable}"/>
        <args/>
      </exec>
      <exec osfamily="unix" executable="@{executable}" outputproperty="exec.output">
        <args/>
      </exec>
      <echo message="${exec.output}" />
    </sequential>
  </macrodef>
  
  <!-- Maven Resolver Ant Task - http://maven.apache.org/resolver-ant-tasks/ -->
  <taskdef uri="antlib:org.apache.maven.resolver.ant" resource="org/apache/maven/resolver/ant/antlib.xml" />

  <macrodef name="installPom">
    <attribute name="pom" default="${basedir}/pom.xml" />
    <sequential>
      <exec osfamily="windows" executable="cmd" outputproperty="exec.output">
        <arg value="/c"/>
        <arg value="mvn"/>
        <arg value="-f" />
        <arg value="@{pom}" />
        <arg value="install" />
      </exec>
      <exec osfamily="unix" executable="mvn" outputproperty="exec.output">
        <arg value="-f" />
        <arg value="@{pom}" />
        <arg value="install" />
      </exec>
      <echo message="${exec.output}" />
    </sequential>
  </macrodef>

  <!-- = = = = = = = = = = = = = = = = =
                macrodef: copyLibraryToAntLib          
               = = = = = = = = = = = = = = = = = -->
  <macrodef name="copyLibraryToAntLib"
            description="Copy given library to ${user.home}/.ant/lib if it is not already there. Also checks for different versions of the library">
    <attribute name="library"
               description="Library name without jar suffix and version number" />
    <sequential>
      <var name="jarfile.fullname" unset="true" />
      <pathconvert property="jarfile.fullname">
        <mapper type="flatten" />
        <fileset dir="${install.lib.dir}">
          <include name="@{library}*.jar" />
        </fileset>
      </pathconvert>
      <if>
        <not>
          <available file="${user.home}/.ant/lib/${jarfile.fullname}" />
        </not>
        <then>
          <!-- remove all other version of the library -->
          <delete failonerror="false">
            <fileset dir="${user.home}/.ant/lib">
              <include name="@{library}*.jar" />
            </fileset>
          </delete>
          <copy todir="${user.home}/.ant/lib">
            <fileset dir="${install.lib.dir}">
              <include name="${jarfile.fullname}" />
            </fileset>
          </copy>
          <fail message="Library ${jarfile.fullname} needed for ant execution was missing. Library copyied to ${user.home}/.ant/lib. Please restart script." />
        </then>
      </if>
    </sequential>
  </macrodef>

  <!-- =================================
         target: update
       ================================= -->
  <target name="update"
          description="Updates installation sequentially from old version to new version.
                       Calls install-ear, install-workflow, install-routing from install.xml">
    <getVersion tag="as" result="as.version" />
    <if>
      <equals arg1="${release.number}" arg2="${as.version}" />
      <then>
        <echo message="This applicationserver has already been updated to version ${as.version}." />
      </then>
      <else>
        <echo message="Start sequential update." />
        <updateSequential update.dir="${ant.file.ant-xyna.dir}/update" />
        <echo message="Finished sequential update." />
        <ant dir="${ant.file.ant-xyna.dir}/.."
             antfile="install.xml"
             target="install-ear" />
        <getVersion tag="db" result="db.version" />
        <if>
          <equals arg1="${release.number}" arg2="${db.version}" />
          <then>
            <echo message="Workflows won't be deployed because the database has 
                           already been updated to version ${db.version}." />
          </then>
          <else>
            <ant dir="${ant.file.ant-xyna.dir}/.."
                 antfile="install.xml"
                 target="install-workflow" />
          </else>
        </if>
        <ant dir="${ant.file.ant-xyna.dir}/.."
             antfile="install.xml"
             target="install-routing" />
      </else>
    </if>
    <echo message="Update complete." />
  </target>

</project>
