<?xml version="1.0" encoding="UTF-8"?>
<!--
 *
 *  Copyright GIP AG 2008
 *  (http://www.gip.com)
 *
 *  Heinrich-von-Brentano-Str. 2
 *  55130 Mainz
 * ___________________________________________________
 *
 *  $Revision:27348 $
 *
 *
 * Achtung: damit die FTP-Downloads bei den Oracle-Tasks funktionieren, muss commons-net-3.3.jar
 * in ~/.ant/lib liegen!
 * 
-->
<project name="delivery" default="localbuild" basedir=".">

  <tstamp>
    <format property="timestamp" pattern="yyyyMMdd_HHmm" locale="de,DE" />
  </tstamp>

  <loadproperties srcfile="delivery.properties" />

  <property name="delivery.build.dir"
            value="${basedir}/${delivery.dir}/build_${timestamp}" />

  <import file="svn.xml" />
  <import file="../build/build.xml" />
  <import file="deliveryMacros.xml" />



  <!-- - - - - - - - - - - - - - - - - -
       target: delivery_os
       - - - - - - - - - - - - - - - - - -->
  <target name="delivery_os">
    <!-- Since we can't use any SVN-stuff -->
    <!-- <exec failonerror="true" executable="${basedir}/check_trunk.sh" /> -->
    <ant antfile="build.xml" dir="${checkout.dir}/installation/build" inheritall="true" inheritrefs="true">
      <target name="${buildTarget}" />
    </ant>
    <replace file="${delivery.build.dir}/func_lib/func_lib.sh"
             token="TOKEN_RELEASE_NUMBER"
             value="${release.number}" />
    <zipDeliveryItemsSrc nameSrc="${delivery.name}_${release.number}_${timestamp}"
                         nameZip="${delivery.name}_${release.number}_${timestamp}${zipName}" />
    <delete dir="${delivery.build.dir}" />
  </target>

  <!-- - - - - - - - - - - - - - - - - -
       target: localbuild_basics
       - - - - - - - - - - - - - - - - - -->
  <target name="localbuild_basics" description="">
    <property name="checkout.dir" value="${basedir}/../.." />
    <property name="buildTarget" value="build_basics" />
    <property name="zipName" value="_localbuild" />
    <ant antfile="delivery.xml" target="delivery_os" inheritall="true" inheritrefs="true"/>
  </target>

  <!-- - - - - - - - - - - - - - - - - -
       target: delivery_basics
       - - - - - - - - - - - - - - - - - -->
  <target name="delivery_basics">
    <property name="checkout.dir" value="${basedir}/../../checkout" />
    <property name="buildTarget" value="build_basics" />
    <property name="zipName" value="" />
    <ant antfile="delivery.xml" target="delivery_os" inheritall="true" inheritrefs="true"/>
  </target>

  <!-- - - - - - - - - - - - - - - - - -
       target: localbuild
       - - - - - - - - - - - - - - - - - -->
  <target name="localbuild" description="build a delivery for all systems from local repository">
    <property name="checkout.dir" value="${basedir}/../.." />
    <exec failonerror="true" executable="${basedir}/check_trunk.sh" />
    <ant antfile="delivery.xml" target="localbuild_basics" inheritall="true" inheritrefs="true"/>
  </target>

  <!-- - - - - - - - - - - - - - - - - -
       target: delivery
       - - - - - - - - - - - - - - - - - -->
  <target name="release" description="build a delivery for all systems from specified SVN-tag">
    <exec failonerror="true" executable="${basedir}/check_trunk.sh" />
    <exec failonerror="true" executable="svn">
      <arg value="update" />
    </exec>
    <exec failonerror="true" executable="svn">
      <arg value="commit" />
      <arg value="-m" />
      <arg value="delivery ${release.number}" />
      <arg value="delivery.properties"/>
    </exec>
    <property name="checkout.dir" value="${basedir}/../../checkout" />
    <ant antfile="svn.xml" target="checkout" inheritall="true" inheritrefs="true" />
    <ant antfile="delivery.xml" target="delivery_basics" inheritall="true" inheritrefs="true"/>
    <delete dir="${checkout.dir}" />
  </target>


</project>
