name: Build Changed Modules
on:
  workflow_dispatch:
   inputs:
     pr-number:
       required: true
       type: string
       default: "551"

  pull_request:
    branches: [ "main" ]       
  
jobs:
  build-changed-modules:
    runs-on: ubuntu-latest
    steps:

     - name: Set up Zulu JDK 11
       uses: actions/setup-java@v3
       with:
         java-version: 11
         distribution: 'zulu'

     - name: Check out xyna-factory
       uses: actions/checkout@v3

     - name: build basic factory
       run: |
          cd installation
          sed -i 's/# main/set -e/' ./build.sh
          sed -i 's/nvm --version//' ./build.sh
          sed -i 's/nvm use .*//' ./build.sh
          ./build.sh build

     - name: prepare module build
       run: |
          cd installation
          source ./build.sh 2>&1 > /dev/null
          prepare_modules
          
     - name: determine changed modules
       env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
       run: |
          gh pr diff ${{ inputs.pr-number }}${{ github.event.pull_request.number }} --name-only | grep '^modules/' | cut -f 2-3 -d/ | sort | uniq | tee changed-modules.txt

     - name: build changed modules
       run: |
          cd modules
          for d in $(cat ../changed-modules.txt); do test -d "$d" && ant -Doracle.home=/tmp -f "$d/build.xml"; done
