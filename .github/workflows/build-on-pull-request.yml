name: Build Changed Modules
on:
  pull_request:
    branches: [ "main" ]       
  
jobs:
  build-changed-modules:
    runs-on: ubuntu-latest
    steps:

     - name: Set up Zulu JDK 11
       uses: actions/setup-java@v3
       with:
         java-version: 11
         distribution: 'zulu'

     - name: Use Node.js 18.10
       uses: actions/setup-node@v3
       with:
         node-version: '18.10'

     - name: Check out xyna-factory
       uses: actions/checkout@v3
          
     - name: determine changed modules
       env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
       run: |
          gh pr diff {{ github.event.pull_request.number }} --name-only | grep '^modules/' | cut -f 2-3 -d/ | sort | uniq | tee changed-modules.txt
          echo "CHANGES=$(cat changed-modules.txt | wc -l)" >> "$GITHUB_ENV"

     - name: build basic factory
       run: |
          cd installation
          ./build.sh build
       if: env.CHANGES > 0

     - name: build changed modules
       run: |
          cd modules
          for d in $(cat ../changed-modules.txt); do test -d "$d" && ant -Doracle.home=/tmp -f "$d/build.xml"; done
       if: env.CHANGES > 0
